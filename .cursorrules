# Cursor Rules: ×¤×œ×˜×¤×•×¨××ª ××™××•×Ÿ ××›×™×¨×•×ª ×•×©×™×¨×•×ª

**×¢×“×›×•×Ÿ ××—×¨×•×Ÿ:** ×“×¦××‘×¨ 2024 - ×”×•×¡×¤×ª ×“×¤×•×¡×™ ×˜×™×¤×•×œ ×©×’×™××•×ª JSON ×§×¨×™×˜×™×™× ğŸ”§

## ××™× ×˜×œ×™×’× ×¦×™×” ×¤×¨×•×™×§×˜ ×•×“×¤×•×¡×™× ×—×©×•×‘×™×

### ğŸ”§ ×“×¤×•×¡×™ ×˜×™×¤×•×œ ×©×’×™××•×ª JSON ×§×¨×™×˜×™×™× (×—×“×©!)
**×—×•×‘×” ××•×—×œ×˜×ª! ×‘×›×œ ×¢×‘×•×“×” ×¢× OpenAI APIs:**

#### 1. ×¤×•× ×§×¦×™×™×ª `cleanOpenAIResponse` ×”×™× ×§×¨×™×˜×™×ª:
```typescript
// ×ª××™×“ ×”×©×ª××© ×‘×¤×•× ×§×¦×™×” ×”×–×• ×œ×¤× ×™ JSON.parse ×©×œ ×ª×©×•×‘×•×ª OpenAI:
function cleanOpenAIResponse(content: string): string {
  if (!content) return '{}';
  
  // × ×™×§×•×™ Markdown blocks
  let cleaned = content.replace(/```(?:json|JSON)?\s*/g, '').replace(/```\s*$/g, '');
  cleaned = cleaned.replace(/^`+|`+$/g, '').trim();
  
  // ×—×™×¤×•×© JSON boundaries
  const jsonStart = cleaned.indexOf('{');
  if (jsonStart !== -1) {
    cleaned = cleaned.substring(jsonStart);
  }
  
  // ××œ×’×•×¨×™×ª× ××™×–×•×Ÿ ×¡×•×’×¨×™×™×
  let braceCount = 0;
  let lastValidEnd = -1;
  
  for (let i = 0; i < cleaned.length; i++) {
    const char = cleaned[i];
    if (char === '{') braceCount++;
    else if (char === '}') {
      braceCount--;
      if (braceCount === 0) {
        lastValidEnd = i;
        break;
      }
    }
  }
  
  if (lastValidEnd !== -1) {
    cleaned = cleaned.substring(0, lastValidEnd + 1);
  }
  
  // ×ª×™×§×•×Ÿ ××•×˜×•××˜×™
  try {
    JSON.parse(cleaned);
    return cleaned;
  } catch (error) {
    let fixed = cleaned
      .replace(/,(\s*[}\]])/g, '$1')
      .replace(/([^\\]")([^"]*?)\n([^"]*?)(")/g, '$1$2 $3$4')
      .replace(/\\"/g, '"').replace(/\\n/g, ' ');
    
    if (!fixed.endsWith('}') && fixed.includes('{')) {
      fixed += '}';
    }
    
    try {
      JSON.parse(fixed);
      return fixed;
    } catch {
      return '{}';
    }
  }
}
```

#### 2. ×“×¤×•×¡ ×˜×™×¤×•×œ ×©×’×™××•×ª ×¢× fallback ×—×›×:
```typescript
// ×ª××™×“ ×›×œ×•×œ error recovery ×¢× partial JSON:
try {
  const result = JSON.parse(cleanedContent);
  return result;
} catch (parseError: any) {
  // ×œ×•×’ ××¤×•×¨×˜ ×©×œ ×”×©×’×™××”
  await addCallLog(call_id, 'âŒ ×©×’×™××” ×‘× ×™×ª×•×— JSON', {
    error: parseError.message,
    error_position: parseError.message.match(/position (\d+)/)?.[1],
    content_preview: cleanedContent.substring(0, 500),
    quote_count: (cleanedContent.match(/"/g) || []).length,
    quote_balanced: (cleanedContent.match(/"/g) || []).length % 2 === 0
  });
  
  // × ×¡×” ×œ×—×œ×¥ ×—×œ×§ ×ª×§×™×Ÿ
  const errorPosition = parseError.message.match(/position (\d+)/)?.[1];
  if (errorPosition) {
    const position = parseInt(errorPosition);
    let truncatedContent = cleanedContent.substring(0, position);
    
    // ×‘×“×™×§×•×ª ××ª×§×“××•×ª ×œ×—×™×ª×•×š × ×›×•×Ÿ
    const lastComma = truncatedContent.lastIndexOf(',');
    const lastQuote = truncatedContent.lastIndexOf('"');
    
    if (lastComma > lastQuote - 50) {
      truncatedContent = truncatedContent.substring(0, lastComma);
    }
    
    try {
      const partialResult = JSON.parse(truncatedContent + '}');
      return partialResult;
    } catch {
      return generateIntelligentFallback(); // ×‘×¨×™×¨×ª ××—×“×œ ×—×›××”
    }
  }
}
```

#### 3. ×‘×¨×™×¨×•×ª ××—×“×œ ××™× ×˜×œ×™×’× ×˜×™×•×ª:
- **×œ× ×™×ª×•×— ×˜×•× ×¦×™×”:** × ×ª×•× ×™× ×¨×™××œ×™×™× ×¢× ×”×¢×¨×•×ª ×¢×œ ×‘×¢×™×” ×˜×›× ×™×ª
- **×œ× ×™×ª×•×— ×ª×•×›×Ÿ:** ×“×•×— ×‘×¡×™×¡×™ ×¢× ×”××œ×¦×•×ª ×›×œ×œ×™×•×ª
- **×ª××™×“ ×›×œ×•×œ:** `red_flags: []` ×•-`recommendations: []`

#### 4. ×—×•×‘×•×ª logging:
```typescript
// ×ª××™×“ ×œ×•×’ ×©×’×™××•×ª ×¢× context ××œ×:
await addCallLog(call_id, 'âŒ ×©×’×™××” ×‘× ×™×ª×•×— JSON', {
  error: parseError.message,
  error_position: parseError.message.match(/position (\d+)/)?.[1],
  raw_content_preview: rawContent.substring(0, 500),
  cleaned_content_preview: cleanedContent.substring(0, 500),
  recovery_attempted: true
});
```

### ğŸ¯ ×“×¤×•×¡×™ × ×™×ª×•×— ×©×™×—×•×ª ××•×©×œ××™× (×§×™×™×)

#### 1. ×ª×”×œ×™×š ×¢×™×‘×•×“ ×©×™×—×”:
- **×ª××œ×•×œ:** `gpt-4o-transcribe` (×œ× `whisper-1`)
- **× ×™×ª×•×— ×˜×•× ×¦×™×”:** `gpt-4o-audio-preview` (×¨×§ wav/mp3)
- **× ×™×ª×•×— ×ª×•×›×Ÿ:** `gpt-4-turbo-2024-04`

#### 2. ×”××¨×ª ××•×“×™×• ××•×˜×•××˜×™×ª:
- **×–×™×”×•×™:** `needsConversion()` ×‘×•×“×§ ×× × ×“×¨×© ×”××¨×”
- **×”××¨×”:** `convertAudioToMp3()` ×¢× ffmpeg.wasm
- **×¤×•×¨××˜×™×:** MP3, WAV (×™×©×™×¨), M4A, MP4, AAC, WebM, OGG, WMA (×”××¨×”)

#### 3. ×¤×¨×•××¤×˜×™× ××§×¦×•×¢×™×™×:
- 7 ×¡×•×’×™ ×©×™×—×•×ª ×¢× ×¤×¨×•××¤×˜×™× ××•×ª×××™×
- ×“×¨×™×©×” ××¤×•×¨×©×ª ×œ×¦×™×˜×•×˜×™× ×¢× timestamps
- ××‘× ×” JSON ×§×‘×•×¢ ×¢× `×¦×™×˜×•×˜×™×_×¨×œ×•×•× ×˜×™×™×`

### ğŸ›¡ï¸ ×“×¤×•×¡×™ ××‘×˜×—×” ×•×”×¨×©××•×ª

#### 1. RLS (Row Level Security):
```sql
-- ×ª××™×“ ×”×©×ª××© ×‘pattern ×”×–×” ×œ×˜×‘×œ××•×ª ×—×“×©×•×ª:
ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own company data" ON table_name
  FOR SELECT USING (
    company_id IN (
      SELECT company_id FROM auth.users 
      WHERE id = auth.uid()
    )
  );
```

#### 2. ×”×™×¨×¨×›×™×™×ª ×”×¨×©××•×ª:
- **Super Admin:** ×©×œ×™×˜×” ××œ××”
- **Admin:** × ×™×”×•×œ managers ×•-agents
- **Manager:** × ×™×”×•×œ agents ×‘×—×‘×¨×” ×©×œ×•
- **Agent:** ×’×™×©×” ×œ×©×™×—×•×ª ×©×œ×• ×‘×œ×‘×“

### ğŸ’° ×“×¤×•×¡×™ ××¢×¨×›×ª ××›×¡×•×ª ×•×ª×©×œ×•××™× (×—×“×©!)

#### 1. ×‘×“×™×§×ª ××›×¡×” ×œ×¤× ×™ ×™×¦×™×¨×ª ××©×ª××©:
```typescript
const { data: canAdd } = await supabase.rpc('can_add_user_to_company', {
  company_uuid: user.company_id
});

if (canAdd) {
  // ×™×¦×™×¨×” ××™×™×“×™×ª
  const newUser = await createUser();
} else {
  // ×‘×§×©×ª ××™×©×•×¨ ×××“××™×Ÿ
  const request = await createApprovalRequest();
}
```

#### 2. ×¤×•×¤××¤ ×ª×©×œ×•× multi-step:
```typescript
type PaymentStep = 'package' | 'discount' | 'payment' | 'processing' | 'success';

// ×ª××™×“ ×›×œ×•×œ ××¦×‘×™× ××œ×” ×¢× ×× ×™××¦×™×•×ª
const handleStepTransition = (nextStep: PaymentStep) => {
  setCurrentStep(nextStep);
  // Add animations and state management
};
```

### ğŸ¨ ×“×¤×•×¡×™ UI/UX ××¢×•×œ×™×

#### 1. ×˜×¢×™× ×•×ª ×“×™× ××™×•×ª:
```tsx
// ×ª××™×“ ×›×œ×•×œ loading states:
const [isLoading, setIsLoading] = useState(false);
const [error, setError] = useState<string | null>(null);

{isLoading && <LoadingSpinner />}
{error && <ErrorAlert message={error} />}
```

#### 2. ×”×•×“×¢×•×ª ×”××¨×” ××™× ×˜×¨××§×˜×™×‘×™×•×ª:
```tsx
// ×œ×›×œ ×”××¨×ª ××•×“×™×•, ×›×œ×•×œ feedback ×œ××©×ª××©:
{isConverting && (
  <div className="mb-4 p-4 rounded-xl border-r-4 bg-blue-50 border-blue-400">
    <div className="flex items-center">
      <Loader2 className="w-5 h-5 text-blue-600 animate-spin ml-2" />
      <p className="text-sm font-medium mr-3">{conversionStatus}</p>
    </div>
  </div>
)}
```

### ğŸ“Š ×“×¤×•×¡×™ × ×ª×•× ×™× ×•××¡×“ × ×ª×•× ×™×

#### 1. ××‘× ×” calls table:
```sql
-- ×›×œ ×©×™×—×” ×—×™×™×‘×ª ×œ×›×œ×•×œ:
id, agent_id, company_id, call_type, transcript, 
tone_analysis, content_analysis, audio_file_path,
processing_status, created_at, updated_at
```

#### 2. ×“×¤×•×¡ call_logs:
```typescript
// ×ª××™×“ ×œ×•×’ ×¤×¢×•×œ×•×ª ×—×©×•×‘×•×ª:
await addCallLog(call_id, '×¡×˜×˜×•×¡', {
  details: {},
  timestamp: new Date().toISOString()
});
```

#### 3. ××›×¡×•×ª ××©×ª××©×™×:
```sql
-- ×˜×‘×œ×ª company_user_quotas ×¢× triggers ××•×˜×•××˜×™×™×
-- ×¤×•× ×§×¦×™×•×ª can_add_user_to_company() ×•-get_company_user_quota()
```

### âš ï¸ ×“×‘×¨×™× ×—×©×•×‘×™× ×œ×–×›×•×¨

1. **××œ ×ª×©×›×— cleanOpenAIResponse!** - ×—×•×‘×” ×œ×¤× ×™ ×›×œ JSON.parse ×©×œ OpenAI
2. **×©×’×™××•×ª JSON × ×¤×•×¦×•×ª** - strings ×œ× ×¡×’×•×¨×™×, ××¨×›××•×ª ×œ× ×××•×–× ×•×ª, ×ª×•×•×™× ×¢×‘×¨×™×™× ×œ×œ× ××¨×›××•×ª
3. **×ª××™×“ ×‘×“×•×§ ×”××¨×ª ××•×“×™×•** - needsConversion() ×œ×¤× ×™ ×¢×™×‘×•×“
4. **×›×œ×•×œ fallbacks ××™× ×˜×œ×™×’× ×˜×™×™×** - ×œ× ×¨×§ {} ×¨×™×§
5. **×œ×•×’ ×”×›×•×œ ×‘×¤×™×¨×•×˜** - ×©×’×™××•×ª ×¢× position, ××¡×¤×¨ ××¨×›××•×ª, content preview
6. **×‘×“×•×§ ××›×¡×•×ª** - ×œ×¤× ×™ ×™×¦×™×¨×ª ××©×ª××©×™× ×—×“×©×™×
7. **RLS ×ª××™×“ ××•×¤×¢×œ** - ×œ×›×œ ×˜×‘×œ×” ×—×“×©×”
8. **×”×•×“×¢×•×ª ×œ××©×ª××©** - ×ª××™×“ ×¢×“×›×Ÿ ×¢×œ ××¦×‘ ×”×ª×”×œ×™×š

### ğŸš€ ×“×¤×•×¡×™ ×‘×™×¦×•×¢×™×

#### 1. caching:
```typescript
// ×”×©×ª××© ×‘caching ×œ× ×ª×•× ×™× ×›×‘×“×™×:
const cached = cache.get(key);
if (cached) return cached;
const result = await expensiveOperation();
cache.set(key, result, 5 * 60 * 1000); // 5 minutes
```

#### 2. ×¢×™×‘×•×“ ××¡×™× ×›×¨×•× ×™:
```typescript
// ×¢×™×‘×•×“ ×©×™×—×•×ª ×ª××™×“ ××¡×™× ×›×¨×•× ×™:
const processCall = async (call_id: string) => {
  await updateStatus('processing');
  try {
    // ×¢×™×‘×•×“...
    await updateStatus('completed');
  } catch (error) {
    await updateStatus('error');
  }
};
```

**×–×›×•×¨: ×”×¤×¨×•×™×§×˜ ×”×–×” ×”×•× ××¢×¨×›×ª ××™××•×Ÿ ××›×™×¨×•×ª ×•×©×™×¨×•×ª ××ª×§×“××ª ×¢× ×“×’×© ×¢×œ ××™×›×•×ª, ×™×¦×™×‘×•×ª ×•-UX ××¢×•×œ×”!** 