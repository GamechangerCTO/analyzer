/**
 * חילוץ פרמטרים חלשים מניתוח שיחה
 * מחלץ את כל הפרמטרים מ-content_analysis עם ציון מתחת לסף
 */

export interface WeakParameter {
  name: string
  hebrewName: string
  score: number
  category: string
  insights?: string
}

/**
 * מחלץ פרמטרים חלשים מה-content_analysis
 * @param contentAnalysis - האובייקט JSON מהניתוח (32 פרמטרים)
 * @param scoreThreshold - סף הציון (ברירת מחדל: 8)
 * @returns מערך של פרמטרים חלשים, ממוין מהחלש ביותר
 */
export function extractWeakParameters(
  contentAnalysis: any,
  scoreThreshold: number = 8
): WeakParameter[] {
  const weakParams: WeakParameter[] = []
  
  if (!contentAnalysis || typeof contentAnalysis !== 'object') {
    return weakParams
  }
  
  // עובר על כל הפרמטרים ב-content_analysis
  Object.entries(contentAnalysis).forEach(([key, value]: [string, any]) => {
    // בודק שיש ציון בפרמטר
    if (value && typeof value === 'object' && 'ציון' in value) {
      const score = parseInt(value.ציון) || 0
      
      // רק פרמטרים חלשים (מתחת לסף)
      if (score < scoreThreshold && score > 0) {
        weakParams.push({
          name: key,
          hebrewName: key.replace(/_/g, ' '),
          score,
          category: getCategoryForParameter(key),
          insights: value.תובנות || value.הערות || ''
        })
      }
    }
  })
  
  // מיון לפי ציון (הכי חלשים קודם)
  return weakParams.sort((a, b) => a.score - b.score)
}

/**
 * מחזיר את הקטגוריה של פרמטר
 */
function getCategoryForParameter(paramName: string): string {
  const categories: Record<string, string> = {
    // התנגדויות וטיפול בבעיות
    'טיפול_בהתנגדויות': 'התנגדויות',
    'התמודדות_עם_דחיה': 'התנגדויות',
    'התמודדות_עם_מחיר': 'התנגדויות',
    
    // סגירה ומעקב
    'סגירת_עסקה': 'סגירה',
    'יצירת_דחיפות': 'סגירה',
    'קריאה_לפעולה': 'סגירה',
    'תיאום_מעקב': 'סגירה',
    
    // תקשורת ובירור
    'בירור_צרכים': 'תקשורת',
    'שאלות_פתוחות': 'תקשורת',
    'הקשבה_פעילה': 'תקשורת',
    'הבנת_כאב': 'תקשורת',
    'הבנת_תהליך_קבלת_החלטות': 'תקשורת',
    
    // הצגת ערך ותועלת
    'הצגת_תועלת': 'ערך ותועלת',
    'הצגת_פתרון': 'ערך ותועלת',
    'התאמת_פתרון': 'ערך ותועלת',
    'ROI_והצדקה': 'ערך ותועלת',
    
    // בניית קשר ואמון
    'בניית_קשר': 'קשר ואמון',
    'יצירת_אמון': 'קשר ואמון',
    'אמפתיה': 'קשר ואמון',
    'התאמה_לסגנון_לקוח': 'קשר ואמון',
    
    // ידע ומקצועיות
    'ידע_מוצר': 'ידע ומקצועיות',
    'הכרת_תחום': 'ידע ומקצועיות',
    'מקצועיות': 'ידע ומקצועיות',
    
    // מבנה ותהליך
    'מבנה_השיחה': 'מבנה ותהליך',
    'פתיחה_חזקה': 'מבנה ותהליך',
    'מעברים': 'מבנה ותהליך',
    'סיכום_ביניים': 'מבנה ותהליך',
    
    // טון ואנרגיה
    'אנרגיה_וחיוביות': 'טון ואנרגיה',
    'בטחון_עצמי': 'טון ואנרגיה',
    'התלהבות': 'טון ואנרגיה'
  }
  
  return categories[paramName] || 'כללי'
}

/**
 * מחזיר טיפים לאתגור הנציג בפרמטר מסוים
 * משמש ליצירת פרומפט AI חכם
 */
export function getChallengeTips(paramName: string): string {
  const tips: Record<string, string> = {
    'טיפול_בהתנגדויות': 'תביע התנגדויות חזקות: "זה יקר מדי", "אני לא בטוח שזה יעבוד אצלי", "אני צריך לחשוב על זה"',
    'סגירת_עסקה': 'תישאר מהסס גם אחרי הצעה טובה. תאמר "אני צריך לחשוב", "אני לא בטוח שזה הזמן"',
    'בירור_צרכים': 'אל תגלה מידע בקלות. תחכה שהנציג ישאל שאלות פתוחות ויבררר לעומק',
    'הצגת_תועלת': 'תשאל "מה זה ייתן לי?" אם הנציג לא מסביר תועלות ספציפיות',
    'בניית_קשר': 'תהיה קצת קר בהתחלה. תן לנציג לעבוד קשה כדי ליצור קשר',
    'יצירת_דחיפות': 'תאמר "אין לי בעיה לחכות" ותראה איך הנציג יוצר דחיפות',
    'הקשבה_פעילה': 'שים לב אם הנציג באמת מקשיב או רק ממתין לתורו לדבר',
    'שאלות_פתוחות': 'שים לב אם הנציג שואל "מה" ו"איך" או רק שאלות סגורות',
    'קריאה_לפעולה': 'ראה אם הנציג מציע צעד הבא ברור או נשאר במעורפל',
    'התמודדות_עם_מחיר': 'תגיד "זה נשמע יקר" ותראה איך הנציג מתמודד עם זה',
    'ROI_והצדקה': 'תשאל "איך זה ישתלם לי?" ותחכה להצדקה כלכלית',
    'פתיחה_חזקה': 'תהיה די אדיש בתחילת השיחה ותראה איך הנציג מושך תשומת לב',
    'מקצועיות': 'תבחן את רמת המקצועיות והדיוק של הנציג',
    'אנרגיה_וחיוביות': 'תהיה עם אנרגיה נמוכה ותראה אם הנציג מעלה את האנרגיה',
    'התאמת_פתרון': 'ספר על מצב ספציפי ותראה אם הנציג מתאים את הפתרון',
    'הבנת_כאב': 'תרמוז על בעיה ותראה אם הנציג מעמיק בהבנת הכאב',
    'יצירת_אמון': 'תהיה קצת חשדן ותראה איך הנציג בונה אמון',
    'ידע_מוצר': 'תשאל שאלות טכניות ותבחן את הידע של הנציג',
    'התמודדות_עם_דחיה': 'תאמר "זה לא מעניין אותי" ותראה איך הנציג מטפל בדחיה',
    'אמפתיה': 'תספר על בעיה ותראה אם הנציג מגלה אמפתיה אמיתית',
    'בטחון_עצמי': 'תאתגר החלטות של הנציג ותראה רמת הבטחון',
    'מבנה_השיחה': 'שים לב אם יש מבנה ברור לשיחה או שזה כאוס',
    'סיכום_ביניים': 'תראה אם הנציג מסכם נקודות חשובות בדרך',
    'מעברים': 'שים לב למעברים בין נושאים - האם הם חלקים?',
    'התלהבות': 'תהיה די אדיש ותראה אם הנציג מצליח להדביק אותך',
    'הכרת_תחום': 'תשאל שאלות על התחום ותבחן הכרות',
    'התאמה_לסגנון_לקוח': 'תהיה עם סגנון מסוים (מהיר/איטי) ותראה התאמה',
    'תיאום_מעקב': 'תראה אם הנציג מתאם צעד המשך ברור עם תאריכים',
    'הבנת_תהליך_קבלת_החלטות': 'תרמוז שיש עוד גורמים בהחלטה ותראה אם הנציג בודק'
  }
  
  return tips[paramName] || 'תאתגר את הנציג בתחום הזה ותראה איך הוא מגיב'
}

/**
 * מקבל מערך של פרמטרים חלשים ומחזיר את הטופ N
 * מסנן כפילויות ומיין לפי חומרה
 */
export function getTopWeakParameters(
  allParams: WeakParameter[],
  limit: number = 5
): WeakParameter[] {
  // הסרת כפילויות (לפי name)
  const uniqueParams = Array.from(
    new Map(allParams.map(p => [p.name, p])).values()
  )
  
  // מיון לפי ציון ולקיחת הטופ N
  return uniqueParams
    .sort((a, b) => a.score - b.score)
    .slice(0, limit)
}

/**
 * מקבץ פרמטרים חלשים לפי קטגוריות
 * שימושי להצגה UI
 */
export function groupParametersByCategory(
  params: WeakParameter[]
): Record<string, WeakParameter[]> {
  const grouped: Record<string, WeakParameter[]> = {}
  
  params.forEach(param => {
    if (!grouped[param.category]) {
      grouped[param.category] = []
    }
    grouped[param.category].push(param)
  })
  
  return grouped
}

/**
 * מחשב ציון ממוצע של פרמטרים
 */
export function calculateAverageScore(params: WeakParameter[]): number {
  if (params.length === 0) return 0
  const sum = params.reduce((acc, p) => acc + p.score, 0)
  return Math.round((sum / params.length) * 10) / 10
}

